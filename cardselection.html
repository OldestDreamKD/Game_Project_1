<!DOCTYPE html>
<html lang="en" class="container-fluid">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playwrite+US+Modern:wght@100..400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
    <title>Card Selection</title>
</head>

<body class="text-center h-100 row align-items-center card-selection-page" id="box">
    <div class="align-items-center my-3">
        <a href="./dashboard.html" class="btn btn-danger my-2 mb-sm-0">Go Back</a>
        <h1 class="fw-light mt-1 flex-sm-grow-1 text-center" id="conceptTitle">Choose a card</h1>

        <div class="container my-5">
            <div class="row g-4 justify-content-center mx-sm-3" id="cardContainer">
                <!-- Cards will be dynamically generated here -->
            </div>
        </div>

        <!-- Modal Structure -->
        <div class="modal fade" id="cardModal" tabindex="-1" aria-labelledby="cardModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content text-bg-dark">
                    <div class="modal-header border-0">
                        <h5 class="modal-title" id="cardModalLabel"></h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <!-- Card flip container -->
                        <div class="flip-card-container" id="flipCardContainer">
                            <div class="flip-card-inner" id="flipCardInner">
                                <div class="flip-card-front" id="modalCardFront">
                                    <!-- Dynamic pattern will be inserted here -->
                                </div>
                                <div class="flip-card-back">
                                    <h2 class="display-4" id="revealedCard"></h2>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary btn-lg mt-4" id="revealBtn">Reveal Card</button>
                    </div>
                    <div class="modal-footer border-0 justify-content-center">
                        <button type="button" class="btn btn-secondary"
                            onclick="window.location.href='./dashboard.html'">Back to Dashboard</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="bubbles">
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
        </div>

        <script>
            /* -------------------------
              Card selection script (fixed)
              - assigns one random image per card
              - re-uses same image for modal (no re-randomize)
            --------------------------*/

            // Return to selection page when modal hidden (optional)
            document.getElementById('cardModal').addEventListener('hidden.bs.modal', () => {
                // Comment out next line if you don't want navigation on close
                // window.location.href = './cardselection.html';
            });

            // Get data from sessionStorage
            const conceptName = sessionStorage.getItem('selectedConcept') || 'Concept';
            const items = JSON.parse(sessionStorage.getItem('selectedItems') || '[]');

            // Page title
            document.getElementById('conceptTitle').textContent = `Choose a card from: ${conceptName}`;

            // Card back images (ensure filenames + case match /assets/)
            const cardBackImages = [
                './assets/C1.jpg', './assets/C2.png', './assets/C3.png', './assets/C4.png',
                './assets/C5.png', './assets/C6.png', './assets/C7.png', './assets/C8.png',
                './assets/C9.png', './assets/C10.png', './assets/C11.png', './assets/C12.png',
                './assets/C13.png', './assets/C14.png', './assets/C15.png', './assets/C16.png',
                './assets/C17.png', './assets/C18.png', './assets/C19.png', './assets/C20.png',
                './assets/C21.png'
            ];

            // Keep track of used indices so we avoid accidental repeats (optional)
            let usedImageIndices = [];

            /* Pick a random unused image index (resets when all used) */
            function pickRandomImageIndex() {
                if (usedImageIndices.length >= cardBackImages.length) usedImageIndices = [];
                let idx;
                do {
                    idx = Math.floor(Math.random() * cardBackImages.length);
                } while (usedImageIndices.includes(idx) && usedImageIndices.length < cardBackImages.length);
                usedImageIndices.push(idx);
                return idx;
            }

            /* Render image HTML for a given image index (deterministic) */
            function renderImageHTML(imageIndex) {
                const imageUrl = cardBackImages[imageIndex % cardBackImages.length];
                return `
            <div style="width:100%;height:100%;position:relative;overflow:hidden;
                        background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);">
              <img src="${imageUrl}"
                   style="width:100%;height:100%;object-fit:cover;opacity:0.95;
                          filter: blur(0.2px) brightness(0.95);"
                   alt="Card back design"
                   onerror="this.style.display='none'; this.parentElement.innerHTML='
                     <div style=\\'width:100%;height:100%;background:linear-gradient(135deg,#667eea,#764ba2);
                     display:flex;align-items:center;justify-content:center;font-size:72px;color:rgba(255,255,255,0.3)\\'>?
                     </div>'">
              <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
                          font-size:120px;color:rgba(255,255,255,0.12);font-weight:bold;
                          text-shadow:0 0 20px rgba(0,0,0,0.5);">?</div>
            </div>
          `;
            }

            /* Generate card grid and store image index on each card */
            const cardContainer = document.getElementById('cardContainer');
            cardContainer.innerHTML = ''; // clear

            items.forEach((item, idx) => {
                const imageIndex = pickRandomImageIndex(); // pick once
                const cardDiv = document.createElement('div');

                // Responsive column classes (adjust as needed)
                cardDiv.className = 'col-6 col-md-4 col-lg-3 d-flex justify-content-center';

                cardDiv.innerHTML = `
            <div class="playing-card" 
                 data-card-text="${escapeHtml(item)}" 
                 data-card-index="${idx}" 
                 data-image-index="${imageIndex}">
              <div class="playing-card-inner">
                <div class="playing-card-front">
                  ${renderImageHTML(imageIndex)}
                </div>
              </div>
            </div>
          `;
                cardContainer.appendChild(cardDiv);
            });

            /* Single delegated click listener for cards (works for dynamically created cards) */
            document.addEventListener('click', (e) => {
                const cardEl = e.target.closest('.playing-card');
                if (!cardEl) return;

                const cardText = cardEl.getAttribute('data-card-text') || '';
                const imageIndex = parseInt(cardEl.getAttribute('data-image-index'), 10);

                const modal = new bootstrap.Modal(document.getElementById('cardModal'));
                document.getElementById('cardModalLabel').textContent = `Guess the card from ${conceptName}`;
                document.getElementById('revealedCard').textContent = cardText;

                // Use the stored image index — do NOT re-randomize
                document.getElementById('modalCardFront').innerHTML = renderImageHTML(imageIndex);

                // Reset flip state
                document.getElementById('flipCardInner').classList.remove('flipped');

                // Reset reveal button text/state
                const revealBtn = document.getElementById('revealBtn');
                revealBtn.disabled = false;
                revealBtn.textContent = 'Reveal Card';

                modal.show();
            });

            /* Reveal button */
            document.getElementById('revealBtn').addEventListener('click', function () {
                document.getElementById('flipCardInner').classList.add('flipped');
                this.disabled = true;
                this.textContent = 'Revealed!';
            });

            /* When modal fully closed — reset reveal button (just in case) */
            document.getElementById('cardModal').addEventListener('hidden.bs.modal', function () {
                const revealBtn = document.getElementById('revealBtn');
                revealBtn.disabled = false;
                revealBtn.textContent = 'Reveal Card';
            });

            /* Utility: escape quotes for attributes (simple) */
            function escapeHtml(str) {
                if (typeof str !== 'string') return str;
                return str.replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
            }
        </script>

    </div>
</body>

</html>